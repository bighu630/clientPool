# ClientPool ä»£ç ç”Ÿæˆå·¥å…·

è‡ªåŠ¨ç”Ÿæˆå®¢æˆ·ç«¯æ± åŒ…è£…ä»£ç ï¼Œä¸ºæ¥å£æˆ–ç»“æ„ä½“çš„æ‰€æœ‰å…¬æœ‰æ–¹æ³•è‡ªåŠ¨æ·»åŠ è¿æ¥æ± ç®¡ç†å’Œ Prometheus ç›‘æ§ã€‚

## åŠŸèƒ½ç‰¹æ€§

- ğŸ” **è‡ªåŠ¨è¯†åˆ«æ–¹æ³•**ï¼šåˆ†ææ¥å£æˆ–ç»“æ„ä½“çš„æ‰€æœ‰å…¬æœ‰æ–¹æ³•ï¼ˆåŒ…æ‹¬ç»§æ‰¿çš„æ–¹æ³•ï¼‰
- ğŸ¯ **æ™ºèƒ½åŒ…è£…**ï¼šè‡ªåŠ¨ç”Ÿæˆå¸¦è¿æ¥æ± ç®¡ç†çš„åŒ…è£…æ–¹æ³•
- ğŸ“Š **Prometheus é›†æˆ**ï¼šè‡ªåŠ¨æ³¨å…¥æ–¹æ³•ååˆ° contextï¼Œæ”¯æŒç›‘æ§ç»Ÿè®¡
- ğŸ”„ **Context æ”¯æŒ**ï¼šæ™ºèƒ½è¯†åˆ«å’Œä¼ é€’ context.Context å‚æ•°
- âš ï¸ **é”™è¯¯å¤„ç†**ï¼šè‡ªåŠ¨å¤„ç† error è¿”å›å€¼
- ğŸ“¦ **åŒ…å¯¼å…¥ç®¡ç†**ï¼šè‡ªåŠ¨æ”¶é›†å’Œç®¡ç†æ‰€éœ€çš„å¯¼å…¥

## å®‰è£…

```bash
go install github.com/bighu630/clientPool/cmd/codegen@latest
```

æˆ–è€…ä»æºç æ„å»ºï¼š

```bash
cd cmd/codegen
go build -o codegen
```

## ä½¿ç”¨æ–¹æ³•

### å‘½ä»¤è¡Œå‚æ•°

```bash
codegen -package=<åŒ…è·¯å¾„> -type=<ç±»å‹å> -wrapper=<åŒ…è£…å™¨å> -client=<å®¢æˆ·ç«¯ç±»å‹> -output=<è¾“å‡ºè·¯å¾„> [é€‰é¡¹]
```

**å¿…éœ€å‚æ•°ï¼š**
- `-package`ï¼šæºæ¥å£æˆ–ç»“æ„ä½“çš„åŒ…è·¯å¾„
- `-type`ï¼šæºæ¥å£æˆ–ç»“æ„ä½“åç§°
- `-wrapper`ï¼šç”Ÿæˆçš„åŒ…è£…å™¨åç§°
- `-client`ï¼šå®¢æˆ·ç«¯ç±»å‹ï¼ˆç”¨äºæ³›å‹ï¼‰
- `-output`ï¼šè¾“å‡ºæ–‡ä»¶è·¯å¾„

**å¯é€‰å‚æ•°ï¼š**
- `-pool`ï¼šå®¢æˆ·ç«¯æ± å­—æ®µåï¼ˆé»˜è®¤: "pool"ï¼‰
- `-prometheus`ï¼šæ˜¯å¦åŒ…å« Prometheus ç›‘æ§ï¼ˆé»˜è®¤: trueï¼‰

### ç¤ºä¾‹

å‡è®¾ä½ æœ‰ä¸€ä¸ª RPC å®¢æˆ·ç«¯æ¥å£ï¼š

```go
package rpc

type Client interface {
    GetSlot(ctx context.Context, commitment CommitmentType) (uint64, error)
    GetBlockHeight(ctx context.Context, commitment CommitmentType) (uint64, error)
    GetBalance(ctx context.Context, account string) (uint64, error)
}
```

ç”ŸæˆåŒ…è£…ä»£ç ï¼š

```bash
codegen \
  -package=github.com/your/project/rpc \
  -type=Client \
  -wrapper=MultiRPCClient \
  -client=*rpc.Client \
  -output=./generated/multi_rpc_client.go
```

ç”Ÿæˆçš„ä»£ç ï¼š

```go
// Code generated by clientPool codegen. DO NOT EDIT.

package generated

import (
	"context"
	"github.com/bighu630/clientPool/middleware"
	"github.com/your/project/rpc"
)

// GetSlot wraps the client method with pool management and monitoring
func (m *MultiRPCClient) GetSlot(ctx context.Context, commitment rpc.CommitmentType) (ret0 uint64, err error) {
	ctx = context.WithValue(ctx, middleware.PrometheusMethodKey{}, "get_slot")
	err = m.pool.Do(ctx, func(ctx context.Context, client *rpc.Client) error {
		ret0, err = client.GetSlot(ctx, commitment)
		return err
	})
	return
}

// GetBlockHeight wraps the client method with pool management and monitoring
func (m *MultiRPCClient) GetBlockHeight(ctx context.Context, commitment rpc.CommitmentType) (ret0 uint64, err error) {
	ctx = context.WithValue(ctx, middleware.PrometheusMethodKey{}, "get_block_height")
	err = m.pool.Do(ctx, func(ctx context.Context, client *rpc.Client) error {
		ret0, err = client.GetBlockHeight(ctx, commitment)
		return err
	})
	return
}

// GetBalance wraps the client method with pool management and monitoring
func (m *MultiRPCClient) GetBalance(ctx context.Context, account string) (ret0 uint64, err error) {
	ctx = context.WithValue(ctx, middleware.PrometheusMethodKey{}, "get_balance")
	err = m.pool.Do(ctx, func(ctx context.Context, client *rpc.Client) error {
		ret0, err = client.GetBalance(ctx, account)
		return err
	})
	return
}
```

### é…åˆä½¿ç”¨

åœ¨ç”Ÿæˆçš„æ–‡ä»¶åŒç›®å½•ä¸‹ï¼Œæ‰‹åŠ¨åˆ›å»ºåŒ…è£…å™¨ç»“æ„ä½“ï¼š

```go
package generated

import (
	clientpool "github.com/bighu630/clientPool"
	"github.com/your/project/rpc"
)

type MultiRPCClient struct {
	pool *clientpool.ClientPool[*rpc.Client]
}

func NewMultiRPCClient(pool *clientpool.ClientPool[*rpc.Client]) *MultiRPCClient {
	return &MultiRPCClient{
		pool: pool,
	}
}
```

ç„¶åä½¿ç”¨ï¼š

```go
package main

import (
	"context"
	"time"
	
	clientpool "github.com/bighu630/clientPool"
	"github.com/bighu630/clientPool/middleware"
	"github.com/your/project/generated"
	"github.com/your/project/rpc"
)

func main() {
	// åˆ›å»ºå®¢æˆ·ç«¯æ± 
	pool := clientpool.NewClientPool[*rpc.Client](3, 5*time.Second, clientpool.RoundRobin)
	
	// æ³¨å†Œä¸­é—´ä»¶
	pool.RegisterMiddleware(middleware.PrometheusMiddleware[*rpc.Client]())
	
	// æ·»åŠ å®¢æˆ·ç«¯
	client1 := rpc.NewClient("https://api.mainnet-beta.solana.com")
	client2 := rpc.NewClient("https://solana-api.projectserum.com")
	pool.AddClient(client1, 1)
	pool.AddClient(client2, 1)
	
	// åˆ›å»ºåŒ…è£…å™¨
	multiClient := generated.NewMultiRPCClient(pool)
	
	// ä½¿ç”¨åŒ…è£…å™¨æ–¹æ³•ï¼ˆè‡ªåŠ¨è´Ÿè½½å‡è¡¡ + ç›‘æ§ï¼‰
	slot, err := multiClient.GetSlot(context.Background(), rpc.CommitmentFinalized)
	if err != nil {
		panic(err)
	}
	println("Current slot:", slot)
}
```

## é«˜çº§ç”¨æ³•

### ç”Ÿæˆä¸å¸¦ Prometheus ç›‘æ§çš„ä»£ç 

```bash
codegen \
  -package=github.com/your/project/rpc \
  -type=Client \
  -wrapper=MultiRPCClient \
  -client=*rpc.Client \
  -output=./generated/multi_rpc_client.go \
  -prometheus=false
```

### è‡ªå®šä¹‰æ± å­—æ®µå

```bash
codegen \
  -package=github.com/your/project/rpc \
  -type=Client \
  -wrapper=MultiRPCClient \
  -client=*rpc.Client \
  -output=./generated/multi_rpc_client.go \
  -pool=rpcPool
```

ç”Ÿæˆçš„ä»£ç å°†ä½¿ç”¨ `m.rpcPool.Do(...)` è€Œä¸æ˜¯ `m.pool.Do(...)`ã€‚

## æ³¨æ„äº‹é¡¹

1. **åªç”Ÿæˆå…¬æœ‰æ–¹æ³•**ï¼šç§æœ‰æ–¹æ³•ï¼ˆå°å†™å­—æ¯å¼€å¤´ï¼‰ä¸ä¼šè¢«ç”Ÿæˆ
2. **ç»§æ‰¿æ–¹æ³•**ï¼šå¦‚æœç±»å‹åµŒå…¥äº†å…¶ä»–æ¥å£æˆ–ç»“æ„ä½“ï¼ŒåµŒå…¥ç±»å‹çš„å…¬æœ‰æ–¹æ³•ä¹Ÿä¼šè¢«ç”Ÿæˆ
3. **Context å‚æ•°**ï¼šç”Ÿæˆå™¨ä¼šè‡ªåŠ¨è¯†åˆ« `context.Context` å‚æ•°å¹¶æ­£ç¡®ä¼ é€’
4. **Error è¿”å›å€¼**ï¼šç”Ÿæˆå™¨ä¼šè‡ªåŠ¨è¯†åˆ« `error` è¿”å›å€¼å¹¶æ­£ç¡®å¤„ç†
5. **æ–¹æ³•åè½¬æ¢**ï¼šPrometheus æ–¹æ³•åä¼šè‡ªåŠ¨è½¬æ¢ä¸ºè›‡å½¢å‘½åï¼ˆå¦‚ `GetSlot` -> `get_slot`ï¼‰

## ä¸ Prometheus é›†æˆ

ç”Ÿæˆçš„ä»£ç ä¼šè‡ªåŠ¨åœ¨ context ä¸­æ³¨å…¥æ–¹æ³•åï¼Œé…åˆ `PrometheusMiddleware` å¯ä»¥å®ç°æŒ‰æ–¹æ³•çš„ç›‘æ§ç»Ÿè®¡ï¼š

```go
pool.RegisterMiddleware(middleware.PrometheusMiddleware[*rpc.Client]())
```

è¿™æ ·æ¯ä¸ªæ–¹æ³•çš„è°ƒç”¨éƒ½ä¼šè¢« Prometheus è®°å½•ï¼Œå¯ä»¥åœ¨ `/metrics` ç«¯ç‚¹æŸ¥çœ‹ï¼š

```
middleware_requests_total{client="client1",method="get_slot"} 100
middleware_request_duration_seconds{client="client1",method="get_slot"} 0.05
middleware_request_errors_total{client="client1",method="get_slot"} 2
```

## æ•…éšœæ’é™¤

### æ‰¾ä¸åˆ°ç±»å‹

ç¡®ä¿ `-package` å‚æ•°æ˜¯å®Œæ•´çš„åŒ…è·¯å¾„ï¼Œä¸”è¯¥åŒ…å·²ç»åœ¨ `go.mod` ä¸­ï¼š

```bash
go get github.com/your/project/rpc
```

### å¯¼å…¥é”™è¯¯

ç”Ÿæˆçš„ä»£ç å¯èƒ½éœ€è¦æ‰‹åŠ¨è°ƒæ•´å¯¼å…¥è·¯å¾„ï¼Œç¡®ä¿æ‰€æœ‰ä¾èµ–éƒ½æ­£ç¡®å¯¼å…¥ã€‚

### ç”Ÿæˆçš„æ–¹æ³•ç­¾åä¸æ­£ç¡®

æ£€æŸ¥æºç±»å‹çš„æ–¹æ³•ç­¾åï¼Œç¡®ä¿å‚æ•°å’Œè¿”å›å€¼ç±»å‹éƒ½æ˜¯å¯å¯¼å‡ºçš„ã€‚

## è´¡çŒ®

æ¬¢è¿æäº¤ Issue å’Œ Pull Requestï¼
